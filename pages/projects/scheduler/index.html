<!doctype html>
<div class="page">
    <style id="style">

        #schedule {
            table-layout: fixed;
            border-collapse: separate;
            border-spacing: 4px;
            width: 100%;
            background-color: white;
            text-align: center;
        }

        #schedule span.text {
            veritcal-align: center;
        }

        #schedule span.text p {
            margin: 0;
        }

        #blocks {
            width: 5em;
        }

        #schedule td, #schedule th {
            border-radius: 0px;
            height: 4.5em;
            max-height: 5em;
            overflow: hidden;
            white-space: nowrap;
            box-sizing: border-box;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            color: white;
            text-align: center;
        }

        #schedule th {
            background-color: rgb(18, 89, 201);
            color: white;
        }

        #schedule th:first-child {
            padding-left: 0;
            padding-right: 0;
        }

        #schedule th.mods {
            background-color: rgb(20, 20, 20);
        }

        #schedule td {
            background-color: rgb(240, 240, 240);
            border: 1px solid rgb(200, 200, 200);
        }

        #schedule td p {
            line-height: 1.2em;
        }

        #schedule td:not(.mod) {
            padding: 0;
        }

        #schedule th.top {
            height: 3em;
        }

        #mod-entry {
            table-layout: fixed;
            border-collapse: separate;
            border-spacing: 2px;
            width: 100%;
            background-color: white;
            text-align: center;
        }

        #mod-entry th, td {
            font-weight: normal;
            font-family: "Roboto", Arial, sans-serif;
            color: black;
            border: 1px solid black;
            font-size: 1.2rem;
            text-align: center;
            border-radius: 0;
            padding: 0;
        }

        #mod-entry td:not(.selected):not(.mod):not(.noclass):hover {
            background-color: rgba(0, 182, 57, 0.3);
        }

        #mod-entry .noclass {
            background-color: rgb(240, 240, 240);
        }

        #mod-entry td.selected {
            background-color: rgb(0, 182, 57);
        }

        #mod-entry td.selected:hover {
            background-color: rgba(255, 62, 62, 0.3);
        }

        input {
            font-size: 1.2em;
        }

        .section {
            border: 1px solid rgb(200, 200, 200);
            padding: 1%;
            margin: 2% 0%;
        }

        #color-label {
            vertical-align: middle;
        }

        .form-container {
            margin: 1%;
            padding: 1%;
        }

        .page-section {
            margin: 2% 0;
        }

        .protip {
            margin: 0% 0% 1% 0%;
            height: auto;
            background-color: rgb(250, 250, 250);
            color: rgb(100, 100, 100);
            border-radius: 2px;
            padding: 0.5em;
        }

        .protip.protip-green {
            background-color: rgba(0, 182, 57, 0.3);
            color: rgb(0, 100, 57);
        }

        .protip.protip-yellow {
            background-color: rgba(227, 182, 0, 0.3);
            color: rgb(128, 100, 0);
        }

        #success, #auto-success {
            color: rgb(0, 147, 59);
        }

        #fail, #success, #messages, #auto-success, #auto-messages {
            opacity: 0;
        }

        #iday-warning {
            opacity: 0;
            color: #DEB928;
            background-color: #F2DA77;
            border: 1px solid #DEB928;
            border-radius: 2px;
            font-size: 12pt;
        }

        .nodisplay {
            display: none;
        }

        #submit-button, #auto-button, #print-button, #reset-button {
            font-size: 12pt;
            font-weight: 300;
        }
    </style>
    <h1><b>George's Schedule Machine</b></h1>
    <p class="protip"><i>Designed for use by IMSA students. Best if used on a desktop browser.</i></p>
    <p class="protip hidemenu"><i><a onclick="hideMenu()" href="javascript:void(0);">Click here</a> to hide the side
        bar.</i></p>
    <p class="protip showmenu"><i><a onclick="showMenu()" href="javascript:void(0);">Click here</a> to show the side
        bar.</i></p>
    <div class="section" style="padding: 16px 1% 0 1%;">
        <p>Powerschool Schedule doesn't make sense? Or maybe it's just too ugly. In any case, this schedule machine is
            here to help!</p>
        <p>Use the Fancy Auto-Scheduler or the Schedule Commander below to enter your classes and watch your schedule
            automagically appear!</p>
        <p>When you're done, you can hit "Print" to open a formatted view of your schedule for printing and
            screenshotting.</p>
    </div>
    <p class="protip"><i><b>That's pretty neat!</b> The Schedule Machine was first developed over the summer of 2014 as
        a bulk-input schedule visualizer. This is its 3rd iteration. It's changed in style a bit since then, but its
        goal is the same: make schedule-sharing easy and fun!</i></p>
    <div class="content">
        <h2>Fancy Auto-Scheduler</h2>
        <div class="page-section">
            <p class="protip protip-green"><b>This feature is experimental.</b> Copy and paste the entire semester table
                from PowerSchool into this text area. The sections should be separated by tabs, and each class should be
                on a new row. Then hit "Update"&ndash;The Schedule Machine will try to do the scheduling for you.<b> Be
                    sure to check that it's correct!</b></p>
            <p class="protip protip-yellow"><b>Known bugs:</b><br/>-> Empty lines in your schedule (such as at the end),
                will result in an error, but the scheduler still works nonetheless. Scroll down and take a look!<br/>->
                PowerSchool's table can sometimes have quirks. If there are mistakes, you edit the classes with the
                Schedule Commander below. You can also use it to change the colors!</p>
            <div class="section">
                <div class="row">
                    <div class="twelve columns">
                        <label for="powerschool-entry">PowerSchool Schedule</label>
                        <textarea id="powerschool-entry" class="u-full-width"
                                  name="powerschool"></textarea>
                    </div>
                </div>
            </div>
            <button id="auto-button" class="button-primary" onClick="autoSchedule()">
                Update
            </button>
            <p style="display: inline-block;"><i id="auto-success">Success.</i><span
                    id="auto-messages"></span></p>
        </div>
        <div class="page-section">
            <h2>Schedule Commander</h2>
            <p class="protip protip-green"><i><b>Protip:</b> You can click on classes in the table to edit them
                here.</i></p>
            <p class="protip protip-yellow"><i><b>Note:</b> I-day MSI might not follow the usual mod times, but for the
                sake of visualization, use the first block on I-day for the first MSI class, and the second one for the
                second class.</i></p>
            <div id="schedule-command" class="section row" style="padding-top: 20px;">
                <div class="six columns">
                    <div class="row">
                        <div class="twelve columns">
                            <label for="class-name">Course Name</label>
                            <input id="class-name" class="u-full-width" type="text" name="classname">
                        </div>
                    </div>
                    <div class="row">
                        <div class="twelve columns">
                            <label for="teacher-name">Teacher</label>
                            <input id="teacher-name" class="u-full-width" type="text" name="teacher">
                        </div>
                    </div>
                    <div class="row">
                        <div class="twelve columns">
                            <label for="room-name">Room Number</label>
                            <input id="room-name" class="u-full-width" type="text" name="room">
                        </div>
                    </div>
                    <div class="row">
                        <div class="twelve columns">
                            <label for="label-color">Label Color</label>
                            <select id="label-color" class="u-full-width">
                                <option value="red">Red</option>
                                <option value="yellow">Yellow</option>
                                <option value="green">Green</option>
                                <option value="blue">Blue</option>
                                <option value="purple">Purple</option>
                                <option value="pink">Pink</option>
                                <option value="brown">Brown</option>
                                <option value="cyan">Cyan</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="six columns">
                    <div class="row">
                        <div class="twelve columns">
                            <label>Mods and Days</label>
                            <table id="mod-entry">
                                <tr>
                                    <th style="border: none"></th>
                                    <th>A</th>
                                    <th>B</th>
                                    <th>I/E</th>
                                    <th>C</th>
                                    <th>D</th>
                                </tr>
                                <tr>
                                    <td class="mod">1</td>
                                    <td></td>
                                    <td></td>
                                    <td rowspan="2"></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td class="mod">2</td>
                                    <td></td>
                                    <td></td>
                                    <td class="nodisplay"></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td class="mod">3</td>
                                    <td></td>
                                    <td></td>
                                    <td rowspan="2"></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td class="mod">4</td>
                                    <td></td>
                                    <td></td>
                                    <td class="nodisplay"></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td class="mod">5</td>
                                    <td></td>
                                    <td></td>
                                    <td rowspan="4" class="noclass"></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td class="mod">6</td>
                                    <td></td>
                                    <td></td>
                                    <td class="nodisplay"></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td class="mod">7</td>
                                    <td></td>
                                    <td></td>
                                    <td class="nodisplay"></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td class="mod">8</td>
                                    <td></td>
                                    <td></td>
                                    <td class="nodisplay"></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <div class="row">
                        <div class="twelve columns">
                            <button id="reset-button" class="button-secondary"
                                    onClick="resetScheduleCommand()">
                                Reset Commander
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <button id="submit-button" class="button-primary" onClick="updateSchedule()">
            Update
        </button>
        <p style="display: inline-block;"><i id="success">Success.</i><span
                id="messages"></span></p>
    </div>
    <div class="content">
        <h2>Your Schedule</h2>
        <div id="areaToPrint" class="section">
            <table id="schedule">
                <col id="blocks"/>
                <col id="A"/>
                <col id="B"/>
                <col id="I"/>
                <col id="C"/>
                <col id="D"/>
                <tr>
                    <th class="mods top">Mod</th>
                    <th class="top">A</th>
                    <th class="top">B</th>
                    <th class="top">I/E</th>
                    <th class="top">C</th>
                    <th class="top">D</th>
                </tr>
                <tr>
                    <th class="mods">1<br/>8:00AM</th>
                    <td></td>
                    <td></td>
                    <td class="msi" rowspan="2"></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <th class="mods">2<br/>9:00AM</th>
                    <td></td>
                    <td></td>
                    <td class="nodisplay"></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <th class="mods">3<br/>10:00AM</th>
                    <td></td>
                    <td></td>
                    <td class="msi" rowspan="2"></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <th class="mods">4<br/>11:00AM</th>
                    <td></td>
                    <td></td>
                    <td class="nodisplay"></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <th class="mods">5<br/>12:20PM</th>
                    <td></td>
                    <td></td>
                    <td class="msi noclass" rowspan="4"></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <th class="mods">6<br/>1:20PM</th>
                    <td></td>
                    <td></td>
                    <td class="nodisplay"></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <th class="mods">7<br/>2:20PM</th>
                    <td></td>
                    <td></td>
                    <td class="nodisplay"></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <th class="mods">8<br/>3:20PM</th>
                    <td></td>
                    <td></td>
                    <td class="nodisplay"></td>
                    <td></td>
                    <td></td>
                </tr>

            </table>
        </div>
        <button id="print-button" class="button-secondary" onClick="printDiv()">
            Print
        </button>
        <br><br>
        <p class="protip protip-green"><i><b>Protip: Mistakes are OK! Double-click on a box to clear its contents.</b>
            This fights glitches, too!</i></p>
        <p class="protip protip-green"><i><b>Protip:</b> If all you get are borders when you print, try clicking on
            "More Settings" and enabling background graphics. If you only get black and white, try printing with your
            system print dialog.</i></p>

    </div>
    <script>
        function pad(n, width, z) {
            z = z || '0';
            n = n + '';
            return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
        }

        var updateSchedule;
        var autoSchedule;
        var printDiv;

        $(document).ready(function () {
            //values
            var colors = {
                "red": "rgb(255,62,62)",
                "yellow": "rgb(255,182,0)",
                "green": "rgb(0,212,85)",
                "blue": "rgb(40,144,255)",
                "purple": "rgb(155,72,208)",
                "pink": "rgb(255,85,217)",
                "brown": "rgb(136,87,12)",
                "cyan": "rgb(36,209,212)"
            };
            var backcolors = invert(colors);
            var daySequence = ["A", "B", "C", "D", "E"];
            var calendarDaySequence = ["A", "B", "E", "C", "D"];

            function removeFromTable(datastring) {

                var table = $("#schedule")[0];

                for (mod = 1; mod < table.rows.length; mod++) {
                    for (day = 1; day < table.rows[mod].cells.length; day++) {
                        if (table.rows[mod].cells[day].getAttribute("data-schedule") === datastring) {
                            var cell = table.rows[mod].cells[day];
                            cell.innerHTML = "";
                            cell.style.backgroundColor = "";
                            cell.style.border = "";
                            cell.removeAttribute("data-schedule");
                            if (cell.hasAttribute("rowspan") && !cell.classList.contains("msi")) {
                                var nextCell = table.rows[mod + 1].cells[day];
                                cell.removeAttribute("rowspan");
                                nextCell.style.display = "";
                                nextCell.innerHTML = "";
                                nextCell.style.backgroundColor = "";
                                nextCell.style.border = "";
                                nextCell.removeAttribute("data-schedule");
                            }
                        }
                    }
                }
            }

            function addToTable(className, teacherName, roomName, mods, color) {
                var table = $("#schedule")[0];
                var datastring = className + "&#&#!" + roomName + "&#&#!" + teacherName;

                for (i = 0; i < mods.length; i++) {
                    for (j = 0; j < mods[i].length; j++) {
                        if (mods[i][j] == true) {
                            var mod = i + 1;
                            var day = j + 1;
                            table.rows[mod].cells[day].innerHTML = "<span class=\"text\"><p><b>" + className + "</b></p><p><u>" + roomName + "</u></p><p>" + teacherName + "</p></span>";
                            table.rows[mod].cells[day].setAttribute("data-schedule", datastring);
                            table.rows[mod].cells[day].style.backgroundColor = color;
                            table.rows[mod].cells[day].style.border = "1px solid transparent"
                        }
                    }
                }

                for (mod = 1; mod < table.rows.length - 1; mod++) {
                    for (day = 1; day < table.rows[mod].cells.length; day++) {
                        if (table.rows[mod].cells[day].getAttribute("data-schedule") && table.rows[mod + 1].cells[day].getAttribute("data-schedule")) {
                            if (table.rows[mod].cells[day].getAttribute("data-schedule") == table.rows[mod + 1].cells[day].getAttribute("data-schedule")) {
                                if (table.rows[mod].cells[day].style.display != "none") {
                                    table.rows[mod].cells[day].setAttribute("rowspan", 2);
                                    table.rows[mod + 1].cells[day].style.display = "none";
                                }
                            }

                        }
                    }
                }
            }

            updateSchedule = function () {
                try {
                    var table = $("#mod-entry")[0];

                    //form elements
                    var className = $("#class-name").val();
                    var teacherName = $("#teacher-name").val();
                    var roomName = $("#room-name").val();
                    var pickedColor = $("#label-color").val();

                    var mods = [];
                    for (mod = 1; mod < table.rows.length; mod++) {
                        var rowSelect = []
                        for (day = 1; day < table.rows[mod].cells.length; day++) {
                            if (table.rows[mod].cells[day].classList.contains("selected")) {
                                rowSelect.push(true);
                            } else {
                                rowSelect.push(false);
                            }
                        }
                        mods.push(rowSelect);
                    }

                    var color = colors["red"];
                    if (pickedColor) {
                        color = colors[pickedColor]
                    }

                    if ($("#schedule-command").attr("data-schedule")) {
                        removeFromTable($("#schedule-command").attr("data-schedule"));
                        $("#schedule-command").attr("data-schedule", className + "&#&#!" + roomName + "&#&#!" + teacherName)
                    }
                    addToTable(className, teacherName, roomName, mods, color)


                    $("#success").css("opacity", 1);
                    $("#success").animate({opacity: 0}, 1000);
                } catch (e) {
                    $("#messages").html("An error occured. Please let George know what happened: <a href=\"mailto:george@george.moe\" target=\"_blank\">george@george.moe</a>.");
                    $("#messages").css("opacity", 1);
                    $("#messages").delay(5000).animate({opacity: 0}, 2000);
                    console.log(e);
                }
            };

            autoSchedule = function () {
                try {
                    var powerschool = $("#powerschool-entry").val();
                    powerschool = powerschool.split("\n");
                    powerschool = powerschool.map(function (entry) {
                        return entry.split("\t")
                    });

                    powerschool.forEach(function (entry) {
                        var expression = entry[0];
                        var className = entry[3];
                        var teacherName = entry[4];
                        var roomName = entry[5];

                        var color = colors[Object.keys(colors)[Math.floor(Math.random() * Object.keys(colors).length)]];

                        expression = expression.replace(/ +/g, "");
                        expression = expression.split(/\),*(?=[0-9])/g);
                        expression = expression.map(function (v, i, a) {
                            if (i < a.length - 1) return v + ")"; else return v;
                        });
                        expression.forEach(function (exp) {
                            exp = exp.replace(")", "");
                            exp = exp.split("(");
                            var selectedMods = [].concat(...exp[0].split(",").map(function (range) {
                                var rangeCaps = range.split("-");
                                if (rangeCaps.length >= 2) {
                                    var result = [];
                                    var direction = 1;
                                    if (parseInt(rangeCaps[0]) > parseInt(rangeCaps[1])) {
                                        direction = -1;
                                    }
                                    for (i = parseInt(rangeCaps[0]); i != parseInt(rangeCaps[1]) + direction; i = i + direction) {
                                        result.push(i);
                                    }
                                    return result;
                                } else {
                                    return [parseInt(rangeCaps[0])];
                                }
                            })
                        )
                            ;
                            var selectedDays = [].concat(...exp[1].split(",").map(function (range) {
                                var rangeCaps = range.split("-");
                                if (rangeCaps.length >= 2) {
                                    var result = [];
                                    var direction = 1;
                                    if (daySequence.indexOf(rangeCaps[0]) > daySequence.indexOf(rangeCaps[1])) {
                                        direction = -1;
                                    }
                                    for (i = daySequence.indexOf(rangeCaps[0]); i != daySequence.indexOf(rangeCaps[1]); i = i + direction) {
                                        result.push(daySequence[i]);
                                    }
                                    result.push(rangeCaps[1]);
                                    return result;
                                } else {
                                    return [rangeCaps[0]];
                                }
                            })
                        )
                            ;

                            var mods = [];
                            for (i = 0; i < 8; i++) {
                                var rowSelect = [];
                                for (j = 0; j < 5; j++) {
                                    rowSelect.push(selectedMods.includes(i + 1) && selectedDays.includes(calendarDaySequence[j]));
                                }
                                mods.push(rowSelect);
                            }
                            if (mods[1][2] == true) {
                                mods[1][2] = false;
                                mods[2][2] = true;
                            }

                            addToTable(className, teacherName, roomName, mods, color)
                        });
                    });
                    $("#auto-success").css("opacity", 1);
                    $("#auto-success").animate({opacity: 0}, 1000);
                } catch (e) {
                    $("#auto-messages").html("An error occured. Please let George know what happened: <a href=\"mailto:george@george.moe\" target=\"_blank\">george@george.moe</a>.");
                    $("#auto-messages").css("opacity", 1);
                    $("#auto-messages").delay(5000).animate({opacity: 0}, 2000);
                    console.log(e);
                }
            };

            printDiv = function () {
                var divToPrint = document.getElementById("areaToPrint");
                var style = document.getElementById("style");
                newWin = window.open("");
                newWin.document.write("<link rel=\"stylesheet\" type=\"text/css\" href=\"/pages/projects/scheduler/meta/print.css\" />");
                newWin.document.write(divToPrint.outerHTML);
                newWin.document.getElementById
            };

            resetScheduleCommand = function () {
                var table = $("#mod-entry")[0];

                //form elements
                $("#class-name").val("");
                $("#teacher-name").val("");
                $("#room-name").val("");
                $("#label-color").val("red")
                $("#mod-entry td.selected").removeClass("selected");
                $("#schedule-command").removeAttr("data-schedule");
            };

            $("#schedule td").click(function () {
                resetScheduleCommand();

                var table = $("#schedule")[0];
                var modEntry = $("#mod-entry")[0];
                var data = $(this).attr("data-schedule").split("&#&#!");
                $("#schedule-command").attr("data-schedule", $(this).attr("data-schedule"));

                $("#class-name").val(data[0]);
                $("#teacher-name").val(data[2]);
                $("#room-name").val(data[1]);

                var color = backcolors[$(this).css("backgroundColor").replace(/ +/g, "")];
                $("#label-color").val(color);

                for (mod = 1; mod < table.rows.length; mod++) {
                    for (day = 1; day < table.rows[mod].cells.length; day++) {
                        if (table.rows[mod].cells[day].getAttribute("data-schedule") === $(this).attr("data-schedule")) {
                            modEntry.rows[mod].cells[day].className = modEntry.rows[mod].cells[day].className + " selected";
                        }
                    }
                }
            });

            $("#schedule td").dblclick(function () {

                var table = $("#schedule")[0];

                this.innerHTML = "";
                this.style.backgroundColor = "";
                this.style.border = "";
                this.removeAttribute("data-schedule");
                if (this.hasAttribute("rowspan") && !this.classList.contains("msi")) {
                    var nextCell = table.rows[$(this).parent().parent().children().index($(this).parent()) + 1].cells[$(this).parent().children().index($(this))];
                    this.removeAttribute("rowspan");
                    nextCell.style.display = "";
                    nextCell.innerHTML = "";
                    nextCell.style.backgroundColor = "";
                    nextCell.style.border = "";
                    nextCell.removeAttribute("data-schedule");
                }

            });

            $("#mod-entry td:not(.mod):not(.noclass)").click(function () {
                if ($(this).hasClass("selected")) {
                    $(this).removeClass("selected");
                } else {
                    $(this).addClass("selected");
                }
            });

            $("#schedule td:not(.noclass)").hover(function () {
                    this.style.border = "1px solid #1359c9"
                },
                function () {
                    if (this.style.backgroundColor != "") {
                        this.style.border = "1px solid transparent";
                    }
                    else {
                        this.style.border = "";
                    }
                });

        });

        function invert(obj) {
            var new_obj = {};
            for (var prop in obj) {
                if (obj.hasOwnProperty(prop)) {
                    new_obj[obj[prop]] = prop;
                }
            }
            return new_obj;
        }
        ;
    </script>
</div>

